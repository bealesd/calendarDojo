<html>

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>Calendar</title>

    <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css" />

    <script src="./dateHelper.js" type="text/javascript"></script>
    <script src="./calendarHelper.js" type="text/javascript"></script>
    <script src="./webTimeHelper.js" type="text/javascript"></script>
    <script src="./calendarRepo.js" type="text/javascript"></script>
    <script src="./drawCalendar.js" type="text/javascript"></script>
    <script src="./calendarTimer.js" type="text/javascript"></script>
    <script src="./calendarService.js" type="text/javascript"></script>
    <script src="./eventListener.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="./style.css" />
</head>

<body>
    <div class="navbar">
        <a id="calendar">calendar</a>
        <a id="trends">trends</a>
        <div class="subMenu"></div>
    </div>

    <div id="mainContentOne" class="main calendar" style="display:block;">
        <p id="calendarStatus"></p>
        <heading id="date"></heading>
        <br>
        <br>
        <div id="calendarContainer"></div>
    </div>

    <div id="mainContentTwo" class="main trends" style="display:none;">
        <p>Calendar Trends</p>
    </div>

    <div id="dataStore"></div>

    <form id="addOrEditCalendarEvents"
          style="background-color:#FFFFFF; padding:30px; position: absolute; opacity: 50; width: 298px; height: 267.4px; left: 174px; top: 49px; z-index: 950; display: none;">
        <h3 id="formTitle">Title</h3>
        <div hidden id="eventId"></div>
        <input id="eventTitle" type="text" name="title" placeholder="title"><br>
        <input id="eventTime" type="time" name="when" step='600'><br>
        <input id="eventWhere" type="text" name="where" placeholder="where"><br>
        <input id="eventWho" type="text" name="who" placeholder="who"><br>
        <button id='eventAddOrUpdateButton' type="button" onclick='createOrUpdateCalendarEvent'>Add</button>
        <button id='eventDelete' type="button" onclick="deleteCalendarEvent()">Delete</button>
        <button id='eventClose' type="button" onclick="hideDialog()">Cancel</button>
    </form>


    <script>
        //#region dataStore
        function getJson() { return document.getElementById('dataStore').value };

        function addJson(newJson) {
            var dataStore = document.getElementById('dataStore');
            var oldJson = dataStore.value;
            dataStore.value = updateJson(oldJson, newJson);
        };

        function updateJson(oldJson, newJson) { return Object.assign({}, oldJson, newJson); };
        //#endregion

        //#region submenu
        function calendarSubMenuCallback() {
            var height = window.getComputedStyle(document.querySelectorAll('.navbar > a')[0]).height;
            var previousMonthHtml = `<a style='height:${height}'  class="navBar subMenuElement" id="nextMonth" onclick="calendarBackwards()"><span class="glyphicon glyphicon-menu-left"></span></a>`;
            var nextMonthHtml = `<a style='height:${height}'  class="navBar subMenuElement" id="previousMonth" onclick="calendarForwards()"><span class="glyphicon glyphicon-menu-right"></span></a>`;
            createSubMenu(previousMonthHtml + nextMonthHtml);
        };

        function createSubMenu(subMenuHtml) {
            document.getElementsByClassName('subMenu')[0].innerHTML = subMenuHtml;
        };

        this.subMenuCallbacks = [];

        function registerSubMenuCallbacks(callbackFunction) {
            this.subMenuCallbacks[callbackFunction.name] = callbackFunction;
        };

        function triggerSubMenuCallback(callbackFunction) {
            this.subMenuCallbacks[callbackFunction]();
        };

        function removeSubMenu() {
            document.getElementsByClassName('subMenu')[0].innerHTML = '';
        };
        //#endregion


        this.calendarService = new CalendarService();
        this.calendarService.calendarRepo = new CalendarRepo();
        this.calendarService.drawCalendarService = new DrawCalendar();
        this.calendarService.dateHelper = new DateHelper();
        this.calendarService.calendarTimer = new CalendarTimer();
        this.eventListener = new EventListener();

        (function () {
            window.addEventListener("load", load, false);
            function load() {
                this.setupMenuEvents();
                this.calendarService.get().then((result) => {
                    this.loadCalendarPage();
                }, (err) => {
                    console.log(`Calendar could not be retrieved in ready: ${err}`);
                    //do a retry every 30 seconds
                    setTimeout(function () { /*reload*/ }, 5000);
                });

            }
        }());


        (function () {
            window.addEventListener("resize", resizeThrottler, false);
            var resizeTimeout;
            function resizeThrottler() {
                if (!resizeTimeout) {
                    resizeTimeout = setTimeout(function () {
                        resizeTimeout = null;
                        this.loadCalendarPage();
                    }, 66);
                }
            }
        }());

        //this.eventListener.add(this.loadCalendarPage);
        //this.eventListener.registerResizeCallbacks();

        this.loadCalendarPage = function () {
            // draws calendar, register event listeners for calendar actions, registers events for sub menu(left and right),
            removeSubMenu();
            this.registerSubMenuCallbacks(this.calendarSubMenuCallback);//should be done on page load
            this.calendarService.drawCalendar();
            this.setCalendarEventsFormPosition();
            this.triggerSubMenuCallback('calendarSubMenuCallback');
            this.registerCalendarEventListeners(this.calendarService.currentMonthCalendarArray);
            this.onSubMenuLinkHover();
        };

        this.calendarForwards = function () {
            this.calendarService.dateHelper.updateDate(true);
            this.calendarService.setCalendarEventsForCurrentMonth();
            this.loadCalendarPage();
        };

        this.calendarBackwards = function () {
            this.calendarService.dateHelper.updateDate(false);
            this.calendarService.setCalendarEventsForCurrentMonth();
            this.loadCalendarPage();
        };

        this.setCalendarEventsFormPosition = function () {
            var eventForm = document.getElementById('addOrEditCalendarEvents');
            eventForm.style.left = (window.innerWidth - parseInt(eventForm.style.width, 10)) / 2 + 'px'
            eventForm.style.top = (window.innerHeight - parseInt(eventForm.style.height, 10)) / 2 + 'px'
        };

        this.openAddCalendarForm = function (day) {
            this.calendarService.dateHelper.dayClicked = day;
            document.getElementById('date').value = addJson({ day: day });

            document.getElementById('eventAddOrUpdateButton').innerHTML = 'Add';
            document.getElementById('formTitle').innerHTML = `Add event on ${day}`;

            var titleNode = document.getElementById('eventTitle');
            titleNode.value = "";
            titleNode.placeholder = "title";

            var timeNode = document.getElementById('eventTime');
            timeNode.value = "";
            timeNode.placeholder = "time";

            var whereNode = document.getElementById('eventWhere');
            whereNode.value = "";
            whereNode.placeholder = "where";

            var whoNode = document.getElementById('eventWho');
            whoNode.value = "";
            whoNode.placeholder = "who";

            document.getElementById('eventId').value = "";

            document.getElementById('addOrEditCalendarEvents').style.display = "block";
        };

        this.openUpdateCalendarForm = function (calendarEvent) {
            this.calendarService.dateHelper.dayClicked = calendarEvent.day;
            document.getElementById('date').value = addJson({ day: calendarEvent.day });

            document.getElementById('eventId').value = calendarEvent.id;

            document.getElementById('eventAddOrUpdateButton').innerHTML = 'Update';
            document.getElementById('formTitle').innerHTML = `Add event on ${calendarEvent.day}`;

            var titleNode = document.getElementById('eventTitle');
            titleNode.value = calendarEvent.title;

            var timeNode = document.getElementById('eventTime');
            timeNode.value = calendarEvent.time;

            var whereNode = document.getElementById('eventWhere');
            whereNode.value = calendarEvent.where;

            var whoNode = document.getElementById('eventWho');
            whoNode.value = calendarEvent.who;

            titleNode.placeholder = "title";
            timeNode.placeholder = "00:00";//check
            whereNode.placeholder = "where";
            whoNode.placeholder = "who";

            document.getElementById('addOrEditCalendarEvents').style.display = "block";
        };

        this.hideDialog = function () {
            document.getElementById("addOrEditCalendarEvents").style.display = 'none';
        };

        this.createOrUpdateCalendarEvent = function () {
            var title = document.getElementById("eventTitle").value;
            var time = document.getElementById("eventTime").value;
            var who = document.getElementById("eventWho").value;
            var where = document.getElementById("eventWhere").value;
            var id = document.getElementById("eventId").value;

            if (title.length < 2 || who.length < 2 || where.length < 2) {
                alert('all values must be more than 2 characters');
            }
            else {
                this.calendarService.post(title, time, who, where, id).then(() => {
                    this.calendarService.get().then(() => {
                        this.hideDialog();
                        this.loadCalendarPage();
                    });
                });
            }
            return false
        };

        this.deleteCalendarEvent = () => {
            var id = document.getElementById('eventId').value;

            this.calendarService.delete(id).then(() => {
                this.calendarService.get().then((result) => {
                }).then(() => {
                    this.hideDialog();
                    this.loadCalendarPage();
                });
            });
        };

        registerCalendarEventListeners = function (dayArray) {
            this.onAddCalendarClick();
            this.onUpdateCalendarEventClick(dayArray);
        };

        onClick = function (element, callback, callbackArgs) {
            var clickEvents = ["mousedown", "touchstart", "pointer.down"];
            clickEvents.forEach(function (event) {
                element.addEventListener(event, function () {
                    callback(callbackArgs);
                });
            });
        };

        onMouseOver = function (element, callback, callbackArgs) {
            var clickEvents = ["mouseover"];
            clickEvents.forEach(function (event) {
                element.addEventListener(event, function () {
                    callback(callbackArgs);
                });
            });
        };

        onMouseOut = function (element, callback, callbackArgs) {
            var clickEvents = ["mouseout"];
            clickEvents.forEach(function (event) {
                element.addEventListener(event, function () {
                    callback(callbackArgs);
                });
            });
        };

        onAddCalendarClick = function () {
            document.querySelectorAll('.calendar > div > .block > .add').forEach(function (block) {
                var day = block.id;
                onClick(block, openAddCalendarForm, day);
            });
        };

        this.onUpdateCalendarEventClick = (dayArray) => {
            document.querySelectorAll('.calendar > div > .block .calendarEventGuid').forEach(function (calendarEventGuidObject) {
                var tbody = calendarEventGuidObject.parentNode.parentNode;
                var day = tbody.parentNode.parentNode.children[0].id;

                var trEventGuidObject = calendarEventGuidObject.parentNode;
                var trNodes = Array.prototype.slice.call(tbody.children);
                var calendarEventGuidObjectIndex = trNodes.indexOf(trEventGuidObject);
                var calendarEventTitle = calendarEventGuidObjectIndex + 1;
                var calendarEventTitleObject = tbody.children[calendarEventTitle].children[0];

                eventIndex = Math.floor(calendarEventGuidObjectIndex / 2);
                var calendarEvent = dayArray[day][eventIndex];
                calendarEvent.day = day;

                onClick(calendarEventTitleObject, openUpdateCalendarForm, calendarEvent);
            });
        };

        this.setupMenuEvents = async () => {
            document.querySelectorAll(`.navbar > a`).forEach(function (link) {
                if (!link.classList.contains('subMenu')) {
                    console.log(link.id);
                    onClick(link, pageLoader, link.id);
                }
                onMouseOver(link, function () { link.style.backgroundColor = "black"; });
                onMouseOut(link, function () { link.style.backgroundColor = "#333"; });
            });
        };

        this.onSubMenuLinkHover = () => {
            document.querySelectorAll(`.subMenu > a`).forEach(function (link) {
                onMouseOver(link, function () { link.style.backgroundColor = "black"; });
                onMouseOut(link, function () { link.style.backgroundColor = "#333"; });
            });
        };

        this.getCurrentPage = () => {
            var currentPage;
            document.querySelectorAll(`.main`).forEach((page) => {
                if (page.style.display === 'block') {
                    currentPage = page;
                }
            });
            return currentPage;
        };

        this.getNewPage = (id) => {
            var newPageClass = id;
            if (newPageClass == 'trends')
                this.removeSubMenu();
            else if (newPageClass == 'calendar')
                this.calendarService.drawCalendarService.createCalendarSubMenu();
            console.log(`newpageclass: ${newPageClass}`);
            return document.querySelectorAll(`.main.${newPageClass}`)[0];
        }

        this.pageLoader = function (id) {
            console.log(`getCurrentPage: ${getCurrentPage()}`);
            console.log(`id: ${id}`);
            document.getElementById(`${getCurrentPage().id}`).style.display = 'none';
            getNewPage(id).style.display = 'block';

        }
    </script>

</body>

</html>